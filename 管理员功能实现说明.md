# 管理员功能实现说明

## 概述
本文档说明了 UIPS 系统中管理员功能的完整实现，包括后端 API、前端界面和权限控制。

## 后端实现

### 1. AdminController (src/UIPS.API/Controllers/AdminController.cs)
管理员专用的 API 控制器，所有接口都使用 `[Authorize(Roles = "Admin")]` 保护。

**主要功能：**
- **GET /api/admin/statistics** - 获取系统统计信息（用户数、管理员数、图片数、收藏数）
- **GET /api/admin/users** - 分页获取用户列表
- **PUT /api/admin/users/{id}/role** - 修改用户角色（User/Admin）
- **DELETE /api/admin/users/{id}** - 删除用户
- **POST /api/admin/users/{id}/reset-password** - 重置用户密码
- **GET /api/admin/images** - 分页获取所有图片（包含所有者信息）
- **DELETE /api/admin/images/batch** - 批量删除图片

### 2. DTOs (src/UIPS.API/DTOs/)
新增的数据传输对象：
- **UpdateRoleDto** - 角色更新请求
- **AdminStatisticsDto** - 系统统计信息
- **BatchDeleteDto** - 批量删除请求
- **UserDto** - 用户信息
- **AdminImageDto** - 管理员视图的图片信息（含所有者）
- **ResetPasswordDto** - 密码重置请求

## 前端实现

### 1. IAdminApi (src/UIPS.Client/Services/IAdminApi.cs)
Refit 接口定义，对应后端 AdminController 的所有 API。

### 2. AdminViewModel (src/UIPS.Client/ViewModels/AdminViewModel.cs)
管理员面板的视图模型，实现了完整的 MVVM 模式。

**主要功能：**
- 系统统计信息展示
- 用户列表管理（分页、角色切换、删除、密码重置）
- 图片列表管理（分页、批量删除）
- 错误处理和用户提示

**关键属性：**
- `Statistics` - 系统统计数据
- `Users` - 用户列表
- `Images` - 图片列表
- `CurrentPage`, `PageSize`, `TotalPages` - 分页控制
- `SelectedUserIds`, `SelectedImageIds` - 多选支持

**命令：**
- `LoadStatisticsCommand` - 加载统计信息
- `LoadUsersCommand` - 加载用户列表
- `ToggleUserRoleCommand` - 切换用户角色
- `DeleteUserCommand` - 删除用户
- `ResetPasswordCommand` - 重置密码
- `LoadImagesCommand` - 加载图片列表
- `BatchDeleteImagesCommand` - 批量删除图片
- `GoToPreviousPageCommand`, `GoToNextPageCommand` - 分页导航

### 3. AdminView (src/UIPS.Client/Views/AdminView.xaml)
管理员面板的 UI 界面，使用 Material Design 风格。

**界面结构：**
- **统计卡片区域** - 显示系统关键指标
- **TabControl** - 两个标签页：
  - **用户管理** - 用户列表、角色管理、删除、密码重置
  - **图片管理** - 图片列表、批量删除
- **分页控件** - 上一页/下一页按钮、页码显示

### 4. 服务注册 (src/UIPS.Client/App.xaml.cs)
在 DI 容器中注册：
- `IAdminApi` - Refit 客户端（带 Token 和 SSL 配置）
- `AdminViewModel` - 单例
- `AdminView` - 单例

### 5. 导航集成 (src/UIPS.Client/MainWindow.xaml & MainWindow.xaml.cs)
在主窗口中添加管理员面板导航：
- 新增"管理员面板"导航按钮（仅管理员可见）
- 根据 `UserSession.IsAdmin` 控制按钮可见性
- 实现 `NavigateToAdmin()` 方法切换到管理员视图
- 显示当前用户名称

## 权限控制

### 后端权限
- 使用 `[Authorize(Roles = "Admin")]` 特性保护所有管理员 API
- JWT Token 中包含用户角色信息
- 非管理员访问将返回 403 Forbidden

### 前端权限
- `UserSession.IsAdmin` 属性判断用户角色
- 管理员面板导航按钮仅对管理员可见
- 前端通过 `AuthHeaderHandler` 自动在请求中添加 JWT Token

## 使用流程

### 管理员登录
1. 使用管理员账号登录系统
2. 登录成功后，`UserSession` 存储用户角色
3. 主窗口根据角色显示"管理员面板"按钮

### 用户管理
1. 点击"管理员面板"导航到管理界面
2. 在"用户管理"标签页查看所有用户
3. 可以：
   - 切换用户角色（User ↔ Admin）
   - 删除用户（需确认）
   - 重置用户密码（输入新密码）
   - 分页浏览用户列表

### 图片管理
1. 切换到"图片管理"标签页
2. 查看所有用户上传的图片（显示所有者信息）
3. 可以：
   - 多选图片
   - 批量删除选中的图片
   - 分页浏览图片列表

### 系统统计
- 管理员面板顶部显示实时统计信息：
  - 总用户数
  - 管理员数量
  - 图片总数
  - 收藏总数

## 技术特点

1. **完整的 MVVM 模式** - 视图和逻辑完全分离
2. **异步操作** - 所有 API 调用都是异步的，不阻塞 UI
3. **错误处理** - 完善的异常捕获和用户提示
4. **Material Design** - 现代化的 UI 设计
5. **分页支持** - 大数据量下的性能优化
6. **权限控制** - 前后端双重权限验证
7. **依赖注入** - 使用 DI 容器管理所有服务和视图

## 测试建议

1. **创建管理员账号** - 在数据库中手动设置用户角色为 "Admin"
2. **测试权限控制** - 使用普通用户尝试访问管理员 API（应返回 403）
3. **测试用户管理** - 创建、修改、删除用户
4. **测试图片管理** - 批量删除图片
5. **测试分页** - 创建大量数据测试分页功能
6. **测试错误处理** - 模拟网络错误、无效输入等场景

## 注意事项

1. **密码重置** - 重置后的密码会使用 BCrypt 加密存储
2. **级联删除** - 删除用户时会同时删除其上传的图片和收藏记录
3. **权限验证** - 前端隐藏管理员按钮不代表安全，后端必须验证权限
4. **性能优化** - 使用分页避免一次加载大量数据
5. **用户体验** - 所有危险操作（删除）都需要用户确认

## 文件清单

### 后端文件
- `src/UIPS.API/Controllers/AdminController.cs`
- `src/UIPS.API/DTOs/UpdateRoleDto.cs`
- `src/UIPS.API/DTOs/AdminStatisticsDto.cs`
- `src/UIPS.API/DTOs/BatchDeleteDto.cs`
- `src/UIPS.API/DTOs/UserDto.cs`
- `src/UIPS.API/DTOs/AdminImageDto.cs`
- `src/UIPS.API/DTOs/ResetPasswordDto.cs`

### 前端文件
- `src/UIPS.Client/Services/IAdminApi.cs`
- `src/UIPS.Client/ViewModels/AdminViewModel.cs`
- `src/UIPS.Client/Views/AdminView.xaml`
- `src/UIPS.Client/Views/AdminView.xaml.cs`
- `src/UIPS.Client/App.xaml.cs` (修改)
- `src/UIPS.Client/MainWindow.xaml` (修改)
- `src/UIPS.Client/MainWindow.xaml.cs` (修改)

## 完成状态

✅ 后端 AdminController 实现
✅ 后端 DTOs 定义
✅ 前端 IAdminApi 接口
✅ 前端 AdminViewModel 实现
✅ 前端 AdminView UI 设计
✅ 服务注册和依赖注入
✅ 主窗口导航集成
✅ 权限控制实现
✅ 代码编译通过，无错误

管理员功能已完整实现，可以正常运行！
