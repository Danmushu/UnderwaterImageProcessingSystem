name: CI/CD Pipeline

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  # ========== æ„å»ºå’Œæµ‹è¯• API ==========
  build-and-test:
    name: Build & Test API
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: ğŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
        
    - name: ğŸ“¦ Restore API Dependencies
      run: |
        dotnet restore src/UIPS.API/UIPS.API.csproj
        dotnet restore tests/UIPS.API.Tests/UIPS.API.Tests.csproj
      
    - name: ğŸ”¨ Build API Project
      run: |
        dotnet build src/UIPS.API/UIPS.API.csproj --configuration Release --no-restore
        dotnet build tests/UIPS.API.Tests/UIPS.API.Tests.csproj --configuration Release --no-restore
      
    - name: ğŸ§ª Run Tests
      run: |
        dotnet test tests/UIPS.API.Tests/UIPS.API.Tests.csproj \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "trx;LogFileName=test-results.trx" \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults
      
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: TestResults/**/*.trx
        retention-days: 30
        
    - name: ğŸ“ˆ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: TestResults/**/coverage.cobertura.xml
        retention-days: 30
        
    - name: ğŸ’¬ Comment Test Results on PR
      uses: dorny/test-reporter@v1
      if: github.event_name == 'pull_request'
      with:
        name: Test Results
        path: TestResults/**/*.trx
        reporter: dotnet-trx
        fail-on-error: true

  # ========== ä»£ç è´¨é‡æ£€æŸ¥ ==========
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore API Dependencies
      run: dotnet restore src/UIPS.API/UIPS.API.csproj
      
    - name: ğŸ” Run Code Analysis
      run: dotnet build src/UIPS.API/UIPS.API.csproj --configuration Release --no-restore /p:TreatWarningsAsErrors=false
      
    - name: ğŸ“ Check Code Style (å…è®¸å¤±è´¥)
      continue-on-error: true
      run: dotnet format src/UIPS.API/UIPS.API.csproj --verify-no-changes --verbosity diagnostic

  # ========== å®‰å…¨æ‰«æ ==========
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore API Dependencies
      run: dotnet restore src/UIPS.API/UIPS.API.csproj
        
    - name: ğŸ”’ Scan for Vulnerable Packages
      run: |
        dotnet list src/UIPS.API/UIPS.API.csproj package --vulnerable --include-transitive 2>&1 | tee security-scan.txt
        
    - name: ğŸ“¤ Upload Security Report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan
        path: security-scan.txt

  # ========== æ„å»º Windows å®¢æˆ·ç«¯ ==========
  build-client:
    name: Build WPF Client
    runs-on: windows-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore src/UIPS.Client/UIPS.Client.csproj
      
    - name: ğŸ”¨ Build Client
      run: dotnet build src/UIPS.Client/UIPS.Client.csproj --configuration Release --no-restore

  # ========== å‘å¸ƒæ„å»ºäº§ç‰©ï¼ˆä»… main åˆ†æ”¯ï¼‰==========
  publish-artifacts:
    name: Publish Artifacts
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, security-scan]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ“¦ Restore API Dependencies
      run: dotnet restore src/UIPS.API/UIPS.API.csproj
        
    - name: ğŸ“¦ Publish API
      run: |
        dotnet publish src/UIPS.API/UIPS.API.csproj \
          --configuration Release \
          --output ./publish/api
          
    - name: ğŸ“¤ Upload API Build
      uses: actions/upload-artifact@v4
      with:
        name: api-release
        path: ./publish/api
        retention-days: 30