# 管理员功能测试指南

## 前置准备

### 1. 创建管理员账号
由于注册功能默认创建的是普通用户（Role = "User"），需要手动在数据库中将某个用户的角色改为 "Admin"。

**方法一：使用数据库管理工具**
```sql
-- 查看所有用户
SELECT * FROM Users;

-- 将某个用户设置为管理员（替换 1 为实际的用户 ID）
UPDATE Users SET Role = 'Admin' WHERE Id = 1;
```

**方法二：在注册时临时修改代码**
在 `AuthController.cs` 的 `Register` 方法中临时修改：
```csharp
var user = new User
{
    UserName = dto.UserName,
    PasswordHash = BCrypt.Net.BCrypt.HashPassword(dto.Password),
    Role = "Admin"  // 临时改为 Admin，注册后改回 "User"
};
```

### 2. 启动项目
```bash
# 启动后端 API
cd src/UIPS.API
dotnet run

# 启动前端客户端（新终端）
cd src/UIPS.Client
dotnet run
```

## 测试步骤

### 测试 1：管理员登录和界面显示
1. 使用管理员账号登录系统
2. 登录成功后，主窗口应该显示：
   - 欢迎文本显示用户名："欢迎回来, [用户名]"
   - 左侧导航栏出现"管理员面板 (Admin)"按钮（带盾牌图标）
3. 使用普通用户登录，应该看不到管理员面板按钮

**预期结果：** ✅ 管理员可见管理员面板，普通用户不可见

### 测试 2：系统统计信息
1. 点击"管理员面板"导航按钮
2. 查看顶部的统计卡片，应显示：
   - 总用户数
   - 管理员数量
   - 图片总数
   - 收藏总数
3. 数据应该与数据库实际数据一致

**预期结果：** ✅ 统计信息正确显示

### 测试 3：用户管理 - 查看用户列表
1. 在管理员面板中，默认显示"用户管理"标签页
2. 应该看到用户列表，每个用户显示：
   - 用户 ID
   - 用户名
   - 角色（User 或 Admin）
   - 操作按钮（切换角色、删除、重置密码）
3. 测试分页功能（如果用户数超过每页数量）

**预期结果：** ✅ 用户列表正确显示，分页正常工作

### 测试 4：用户管理 - 切换角色
1. 选择一个普通用户（Role = User）
2. 点击"切换角色"按钮
3. 应该弹出确认对话框
4. 确认后，用户角色应变为 Admin
5. 再次点击"切换角色"，应该变回 User

**预期结果：** ✅ 角色切换成功，界面实时更新

### 测试 5：用户管理 - 删除用户
1. 选择一个测试用户
2. 点击"删除"按钮
3. 应该弹出确认对话框："确定要删除用户 [用户名] 吗？"
4. 确认后，用户应从列表中消失
5. 检查数据库，用户及其相关数据（图片、收藏）应被删除

**预期结果：** ✅ 用户删除成功，级联删除相关数据

### 测试 6：用户管理 - 重置密码
1. 选择一个用户
2. 点击"重置密码"按钮
3. 应该弹出输入对话框
4. 输入新密码（例如："newpass123"）
5. 确认后，应显示成功提示
6. 退出登录，使用新密码登录该用户账号

**预期结果：** ✅ 密码重置成功，可以使用新密码登录

### 测试 7：图片管理 - 查看图片列表
1. 切换到"图片管理"标签页
2. 应该看到所有用户上传的图片，每张图片显示：
   - 图片缩略图
   - 图片 ID
   - 文件名
   - 所有者（用户名）
   - 上传时间
   - 复选框（用于多选）
3. 测试分页功能

**预期结果：** ✅ 图片列表正确显示，包含所有者信息

### 测试 8：图片管理 - 批量删除
1. 在图片列表中勾选多张图片（至少 2 张）
2. 点击"批量删除选中图片"按钮
3. 应该弹出确认对话框："确定要删除选中的 X 张图片吗？"
4. 确认后，选中的图片应从列表中消失
5. 检查数据库和文件系统，图片应被删除

**预期结果：** ✅ 批量删除成功

### 测试 9：权限控制 - 后端 API 保护
使用 API 测试工具（如 Postman 或 UIPS.API.http）测试：

1. **无 Token 访问**
```http
GET https://localhost:7149/api/admin/statistics
```
**预期结果：** ❌ 401 Unauthorized

2. **普通用户 Token 访问**
```http
GET https://localhost:7149/api/admin/statistics
Authorization: Bearer [普通用户的Token]
```
**预期结果：** ❌ 403 Forbidden

3. **管理员 Token 访问**
```http
GET https://localhost:7149/api/admin/statistics
Authorization: Bearer [管理员的Token]
```
**预期结果：** ✅ 200 OK，返回统计数据

### 测试 10：错误处理
1. **网络错误测试**
   - 关闭后端 API
   - 在管理员面板中执行任何操作
   - 应该显示友好的错误提示

2. **无效输入测试**
   - 重置密码时输入空密码
   - 应该有适当的验证提示

3. **并发操作测试**
   - 快速连续点击多个按钮
   - 应该不会崩溃或出现异常

**预期结果：** ✅ 所有错误都有友好提示，不会崩溃

## 性能测试

### 大数据量测试
1. 在数据库中创建大量测试数据（100+ 用户，1000+ 图片）
2. 测试分页加载速度
3. 测试批量删除性能

**预期结果：** ✅ 分页加载快速，批量操作不卡顿

## 常见问题排查

### 问题 1：管理员面板按钮不显示
**原因：** 用户角色不是 "Admin"
**解决：** 检查数据库中用户的 Role 字段，确保是 "Admin"（区分大小写）

### 问题 2：API 返回 403 Forbidden
**原因：** JWT Token 中的角色信息不正确
**解决：** 
1. 检查 `AuthController.cs` 中生成 Token 时是否包含角色 Claim
2. 重新登录获取新的 Token

### 问题 3：删除用户后图片仍然存在
**原因：** 数据库外键约束未正确配置
**解决：** 检查 `UipsDbContext.cs` 中的级联删除配置

### 问题 4：图片缩略图不显示
**原因：** 图片路径或 Base64 数据不正确
**解决：** 检查 `IFileService` 的实现和图片存储方式

## 测试检查清单

- [ ] 管理员登录成功，面板按钮可见
- [ ] 普通用户登录，面板按钮不可见
- [ ] 系统统计信息正确显示
- [ ] 用户列表正确加载和分页
- [ ] 用户角色切换功能正常
- [ ] 用户删除功能正常（含级联删除）
- [ ] 密码重置功能正常
- [ ] 图片列表正确加载和分页
- [ ] 图片批量删除功能正常
- [ ] 后端 API 权限控制有效
- [ ] 错误处理友好，无崩溃
- [ ] 大数据量下性能良好

## 测试完成

如果所有测试项都通过，说明管理员功能已完整实现并可以正常使用！

## 下一步建议

1. **添加日志记录** - 记录管理员的所有操作（审计日志）
2. **添加操作确认** - 对危险操作增加二次确认
3. **添加批量操作** - 支持批量修改用户角色
4. **添加搜索功能** - 在用户和图片列表中添加搜索框
5. **添加排序功能** - 支持按不同字段排序
6. **添加导出功能** - 导出用户列表和统计报表
